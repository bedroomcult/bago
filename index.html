<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar styling for a nicer look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Modal overlay styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Color swatch styling */
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 9999px; /* This makes it a perfect circle/rounded square */
            border: 2px solid #e5e7eb; /* Light gray border */
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        /* Quantity input styling */
        .quantity-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem;
            text-align: center;
            width: 3rem;
        }
        .quantity-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-7xl mx-auto py-8">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-gray-800">Katalog Bago Home Decor</h1>
            <p class="text-lg text-gray-500 mt-2">wkwkwkwk</p>
            <!-- Buttons moved below headline on mobile to prevent overlap -->
            <div class="flex justify-between items-center mt-4">
                <div></div> <!-- Empty div for spacing -->
                
                <div class="flex space-x-2">
                    <button id="settings-btn" class="bg-gray-200 hover:bg-gray-300 rounded-full p-2 shadow transition-colors duration-200" title="Pengaturan">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="currentcolor" viewBox="0 0 24 24"  height="20" width="20">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M24 13.616v-3.232l-2.869-1.02c-.198-.687-.472-1.342-.811-1.955l1.308-2.751-2.285-2.285-2.751 1.307c-.613-.339-1.269-.613-1.955-.811l-1.021-2.869h-3.232l-1.021 2.869c-.686.198-1.342.471-1.955.811l-2.751-1.308-2.285 2.285 1.308 2.752c-.339.613-.614 1.268-.811 1.955l-2.869 1.02v3.232l2.869 1.02c.197.687.472 1.342.811 1.955l-1.308 2.751 2.285 2.286 2.751-1.308c.613.339 1.269.613 1.955.811l1.021 2.869h3.232l1.021-2.869c.687-.198 1.342-.472 1.955-.811l2.751 1.308 2.285-2.286-1.308-2.751c.339-.613.613-1.268.811-1.955l2.869-1.02zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4zz" />
                        </svg>
                    </button>
                    <button id="checkout-toggle" class="bg-gray-200 hover:bg-gray-300 rounded-full p-2 shadow transition-colors duration-200" title="Mode Checkout">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <div id="category-cards" class="flex flex-wrap gap-2 justify-center sm:justify-start w-full sm:w-auto">
                </div>
            
            <div class="flex flex-row items-center gap-4 w-full sm:w-auto flex-nowrap">
                <div class="relative inline-block text-left">
                <button id="sort-button" type="button"
                    class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
                    aria-expanded="true" aria-haspopup="true">
                    Urutkan
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <div id="sort-menu"
                    class="origin-top absolute left-0 right-0 mx-auto mt-2 w-full sm:w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="sort-button">
                    <button data-sort="name-asc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Nama ↑</button>
                    <button data-sort="name-desc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Nama ↓</button>
                    <button data-sort="price-asc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Harga ↑</button>
                    <button data-sort="price-desc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Harga ↓</button>
                    </div>
                </div>
                </div>

                <label for="search-input" class="sr-only">Cari Produk</label>
                <input type="text" id="search-input" placeholder="Cari Produk..."
                    class="block w-full sm:w-64 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                
                <a href="admin.html"
                    class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                    </svg>
                    <span>Edit</span>
                </a>
            </div>
        </div>

        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            </div>

        <div id="empty-message" class="hidden text-center text-gray-500 mt-16">
            <p class="text-xl">Tidak ada produk untuk kategori ini, tambahkan produk dari halaman admin.</p>
        </div>

    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="flex flex-col items-center justify-center py-24">
        <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <p class="text-lg text-gray-600 font-medium">Memuat daftar produk, mohon tunggu...</p>
    </div>

    <div id="product-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-2xl relative max-h-full overflow-y-auto">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <div id="modal-content" class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0 w-full md:w-1/2">
                    <img id="modal-image" src="" alt="" class="w-full rounded-xl object-cover">
                </div>
                <div class="flex-grow md:w-1/2 space-y-4">
                    <h2 id="modal-name" class="text-3xl font-bold text-gray-800"></h2>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                        <p id="modal-price" class="text-2xl font-bold text-indigo-600"></p>
                        <p id="modal-original-price" class="text-gray-400 line-through text-lg"></p>
                    </div>
                    <p class="text-sm text-gray-500 capitalize">Kategori: <span id="modal-category" class="font-medium"></span></p>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <p class="text-gray-700 font-semibold">Detail:</p>
                        <ul class="text-sm text-gray-600 mt-2 space-y-1">
                            <li><strong class="text-gray-800">Deskripsi:</strong> <span id="modal-desc"></span></li>
                            <li><strong class="text-gray-800">Ukuran:</strong> <span id="modal-size"></span></li>
                            <li><strong class="text-gray-800">Stok:</strong> <span id="modal-stock"></span></li>
                        </ul>
                    </div>

                    <div>
                        <p class="text-gray-700 font-semibold">Pilihan Warna:</p>
                        <div id="modal-colors" class="mt-2 space-y-2">
                        </div>
                </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-80 max-w-full relative">
            <button id="close-settings" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-xl font-bold mb-4 text-gray-800">Pengaturan Tampilan</h2>
            <div class="space-y-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="toggle-size" class="form-checkbox">
                    <span class="text-gray-700">Tampilkan Ukuran</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="toggle-color" class="form-checkbox">
                    <span class="text-gray-700">Tampilkan Warna</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="toggle-desc" class="form-checkbox">
                    <span class="text-gray-700">Tampilkan Deskripsi</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Shopping Cart Modal -->
    <div id="cart-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-2xl relative max-h-full overflow-y-auto">
            <button id="close-cart" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Keranjang Belanja</h2>
            
            <div id="cart-items" class="mb-6 max-h-96 overflow-y-auto">
                <!-- Cart items will be populated here -->
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="cart-total-modal">Rp 0</span>
                </div>
                <button id="checkout-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-full">
                    Checkout
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productGrid = document.getElementById('product-grid');
            const categoryCardsContainer = document.getElementById('category-cards');
            const searchInput = document.getElementById('search-input');
            const emptyMessage = document.getElementById('empty-message');
            const sortButton = document.getElementById('sort-button');
            const sortMenu = document.getElementById('sort-menu');
            const productModal = document.getElementById('product-modal');
            const closeModalButton = document.getElementById('close-modal');
            const settingsButton = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsButton = document.getElementById('close-settings');
            const toggleSize = document.getElementById('toggle-size');
            const toggleColor = document.getElementById('toggle-color');
            const toggleDesc = document.getElementById('toggle-desc');
            const loadingSpinner = document.getElementById('loading-spinner');
            const checkoutToggle = document.getElementById('checkout-toggle');
            const cartModal = document.getElementById('cart-modal');
            const closeCartButton = document.getElementById('close-cart');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');
            const cartTotalModal = document.getElementById('cart-total-modal');
            const cartItemsContainer = document.getElementById('cart-items');
            const floatingCalculator = document.getElementById('floating-calculator');

            let allProducts = [];
            let selectedCategory = 'All';
            let currentSort = 'name-asc';
            let showOnlyDiscounted = false;
            let shoppingCart = [];

            // Load cart from localStorage if available
            function loadCartFromStorage() {
                try {
                    const savedCart = localStorage.getItem('shoppingCart');
                    if (savedCart) {
                        shoppingCart = JSON.parse(savedCart);
                        updateCartUI();
                    }
                } catch (e) {
                    console.error('Error loading cart from storage:', e);
                    shoppingCart = [];
                }
            }

            // Save cart to localStorage
            function saveCartToStorage() {
                try {
                    localStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
                } catch (e) {
                    console.error('Error saving cart to storage:', e);
                }
            }

            // Settings state
            let settings = {
                showSize: false,
                showColor: false,
                showDesc: false
            };

            // Cart functionality
            // Load cart from storage on page load
            loadCartFromStorage();
            
            // Track checkout mode state
            let isCheckoutMode = false;
            
            // Use cart button as toggle for checkout mode
            checkoutToggle.addEventListener('click', () => {
                if (!isCheckoutMode) {
                    // Enter checkout mode
                    isCheckoutMode = true;
                    checkoutToggle.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                    checkoutToggle.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                    filterAndDisplayProducts(); // Refresh product display to show add to cart buttons
                    updateCartUI(); // Update cart UI to show floating calculator
                } else {
                    // Exit checkout mode
                    isCheckoutMode = false;
                    checkoutToggle.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                    checkoutToggle.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                    filterAndDisplayProducts(); // Refresh product display to hide add to cart buttons
                    updateCartUI(); // Update cart UI to hide floating calculator
                }
            });

            // Add click event to floating calculator to open cart modal
            floatingCalculator.addEventListener('click', () => {
                cartModal.classList.remove('hidden');
            });

            closeCartButton.addEventListener('click', () => {
                cartModal.classList.add('hidden');
            });

            // Add click event for checkout button
            document.getElementById('checkout-button').addEventListener('click', () => {
                // In a real implementation, this would process the order
                // For now, we'll just show an alert and clear the cart
                alert('Pesanan Anda telah diproses! Terima kasih sudah berbelanja.');
                clearCart();
                cartModal.classList.add('hidden');
            });

            window.addEventListener('click', (event) => {
                if (event.target === cartModal) {
                    cartModal.classList.add('hidden');
                }
            });

            function addToCart(productId) {
                const product = allProducts.find(p => p.id == productId);
                if (product) {
                    const existingItem = shoppingCart.find(item => item.id === product.id);
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        shoppingCart.push({
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            originalPrice: product.originalPrice,
                            image: product.image,
                            quantity: 1
                        });
                    }
                    saveCartToStorage();
                    updateCartUI();
                }
            }

            function updateCartUI() {
                // Update cart count
                const totalItems = shoppingCart.reduce((total, item) => total + item.quantity, 0);
                cartCount.textContent = totalItems;
                
                // Update cart total
                const totalAmount = shoppingCart.reduce((total, item) => total + (item.price * item.quantity), 0);
                cartTotal.textContent = formatRupiah(totalAmount);
                cartTotalModal.textContent = formatRupiah(totalAmount);
                
                // Show/hide floating calculator only when checkout mode is enabled and cart is not empty
                if (totalItems > 0 && isCheckoutMode) {
                    floatingCalculator.classList.remove('hidden');
                } else {
                    floatingCalculator.classList.add('hidden');
                }
                
                // Update cart modal items
                updateCartItems();
            }

            function updateCartItems() {
                if (shoppingCart.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Keranjang kosong</p>';
                    return;
                }
                
                // Calculate totals
                let subtotal = 0;
                let totalDiscount = 0;
                
                const cartItemsHtml = shoppingCart.map(item => {
                    const isDiscounted = item.originalPrice && item.originalPrice > item.price;
                    const displayPrice = isDiscounted ? item.price : (item.originalPrice || item.price);
                    const itemTotal = displayPrice * item.quantity;
                    const discountAmount = isDiscounted ? (item.originalPrice - item.price) * item.quantity : 0;
                    
                    subtotal += itemTotal;
                    totalDiscount += discountAmount;
                    
                    return `
                        <div class="flex items-center py-4 border-b border-gray-200">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded">
                            <div class="ml-4 flex-grow">
                                <h3 class="font-medium">${item.name}</h3>
                                <p class="text-indigo-600">${formatRupiah(displayPrice)} x ${item.quantity}</p>
                                ${isDiscounted ? `<p class="text-gray-400 line-through text-sm">${formatRupiah(item.originalPrice)} each</p>` : ''}
                                ${discountAmount > 0 ? `<p class="text-red-500 text-sm">Diskon: ${formatRupiah(discountAmount)}</p>` : ''}
                                <p class="font-semibold">${formatRupiah(itemTotal)}</p>
                            </div>
                            <div class="flex items-center">
                                <button class="decrease-qty bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center" data-id="${item.id}">-</button>
                                <input type="number" min="1" value="${item.quantity}" class="quantity-input mx-2 w-12 text-center border border-gray-300 rounded" data-id="${item.id}">
                                <button class="increase-qty bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center" data-id="${item.id}">+</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Calculate final total
                const finalTotal = subtotal - totalDiscount;
                
                // Update cart items container with summary
                cartItemsContainer.innerHTML = `
                    ${cartItemsHtml}
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div class="flex justify-between mb-2">
                            <span>Subtotal:</span>
                            <span>${formatRupiah(subtotal)}</span>
                        </div>
                        ${totalDiscount > 0 ? `
                        <div class="flex justify-between mb-2 text-red-500">
                            <span>Diskon:</span>
                            <span>-${formatRupiah(totalDiscount)}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span>${formatRupiah(finalTotal)}</span>
                        </div>
                    </div>
                `;
                
                // Update the total in the modal footer
                cartTotalModal.textContent = formatRupiah(finalTotal);
                
                // Add event listeners for quantity buttons
                document.querySelectorAll('.decrease-qty').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = e.target.dataset.id;
                        changeQuantity(productId, -1);
                    });
                });
                
                document.querySelectorAll('.increase-qty').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = e.target.dataset.id;
                        changeQuantity(productId, 1);
                    });
                });
                
                // Add event listeners for quantity input fields
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        e.stopPropagation();
                        const productId = e.target.dataset.id;
                        const newQuantity = parseInt(e.target.value) || 0;
                        if (newQuantity > 0) {
                            const item = shoppingCart.find(item => item.id == productId);
                            if (item) {
                                item.quantity = newQuantity;
                                saveCartToStorage();
                                updateCartUI();
                            }
                        } else {
                            changeQuantity(productId, -item.quantity); // Remove item if quantity is 0 or invalid
                        }
                    });
                });
            }

            // Function to clear the cart (useful for checkout)
            function clearCart() {
                shoppingCart = [];
                saveCartToStorage();
                updateCartUI();
            }

            function changeQuantity(productId, change) {
                const item = shoppingCart.find(item => item.id == productId);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) {
                        shoppingCart = shoppingCart.filter(item => item.id != productId);
                    }
                    saveCartToStorage();
                    updateCartUI();
                }
            }

            settingsButton.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });
            closeSettingsButton.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
            window.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            toggleSize.addEventListener('change', () => {
                settings.showSize = toggleSize.checked;
                filterAndDisplayProducts();
            });
            toggleColor.addEventListener('change', () => {
                settings.showColor = toggleColor.checked;
                filterAndDisplayProducts();
            });
            toggleDesc.addEventListener('change', () => {
                settings.showDesc = toggleDesc.checked;
                filterAndDisplayProducts();
            });

            async function fetchProducts() {
                loadingSpinner.style.display = 'flex';
                productGrid.style.display = 'none';
                emptyMessage.style.display = 'none';

                try {
                    const response = await fetch('db.json?t=' + new Date().getTime());
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const allData = await response.json();
                    // Add ID to each product based on its index
                    allProducts = allData
                        .map((p, index) => ({ ...p, id: index + 1 }))
                        .filter(p => p.name && !p.hidden);

                    const categories = ['All', ...new Set(
                        allProducts.flatMap(p => p.category ? p.category.split(',').map(c => c.trim()) : [])
                    )];
                    displayCategoryCards(categories);

                    filterAndDisplayProducts();
                } catch (error) {
                    console.error('Error fetching products:', error);
                    productGrid.innerHTML = '<p class="text-red-500 col-span-full">Error loading products.</p>';
                } finally {
                    loadingSpinner.style.display = 'none';
                    productGrid.style.display = '';
                }
            }

            function displayCategoryCards(categories) {
                categoryCardsContainer.innerHTML = '';

                const createButton = (text, isSelected, isSaleButton = false) => {
                    const card = document.createElement('button');
                    card.textContent = text;
                    
                    let baseClasses = 'category-card px-4 py-2 rounded-full text-sm font-medium border transition-colors duration-200 ';
                    let activeClasses = 'bg-indigo-600 text-white border-indigo-600';
                    let inactiveClasses = 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100';

                    if (isSaleButton) {
                        activeClasses = 'bg-red-600 text-white border-red-600';
                    }

                    card.className = baseClasses + (isSelected ? activeClasses : inactiveClasses);
                    return card;
                };

                // "All" button
                const allCard = createButton('Semua Poduk', selectedCategory === 'All');
                allCard.addEventListener('click', () => {
                    selectedCategory = 'All';
                    updateCategoryAndFilter();
                });
                categoryCardsContainer.appendChild(allCard);

                // "On Sale" button
                const saleCard = createButton('DISKON', showOnlyDiscounted, true);
                saleCard.addEventListener('click', () => {
                    showOnlyDiscounted = !showOnlyDiscounted;
                    updateCategoryAndFilter();
                });
                categoryCardsContainer.appendChild(saleCard);

                // Other category buttons
                categories.filter(c => c !== 'All').forEach(category => {
                    const card = createButton(category, selectedCategory === category);
                    card.addEventListener('click', () => {
                        selectedCategory = category;
                        updateCategoryAndFilter();
                    });
                    categoryCardsContainer.appendChild(card);
                });
            }

            function updateCategoryAndFilter() {
                // This function redraws the category buttons to reflect the current state
                const categories = ['All', ...new Set(
                    allProducts.flatMap(p => p.category ? p.category.split(',').map(c => c.trim()) : [])
                )];
                displayCategoryCards(categories);
                filterAndDisplayProducts();
            }

            function filterAndDisplayProducts() {
                const searchTerm = searchInput.value.toLowerCase();
                let filtered = allProducts;

                if (showOnlyDiscounted) {
                    filtered = filtered.filter(item => isCurrentlyDiscounted(item));
                }

                if (selectedCategory && selectedCategory !== 'All') {
                    filtered = filtered.filter(item => 
                        item.category && item.category.split(',').map(c => c.trim()).includes(selectedCategory)
                    );
                }

                if (searchTerm) {
                    filtered = filtered.filter(item =>
                        (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm))
                    );
                }

                sortProducts(filtered);
                displayProducts(filtered);
            }

            function sortProducts(products) {
                switch (currentSort) {
                    case 'name-asc':
                        products.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        products.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'price-asc':
                        products.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-desc':
                        products.sort((a, b) => b.price - a.price);
                        break;
                }
            }

            function displayProducts(products) {
                productGrid.innerHTML = '';
                if (products.length === 0) {
                    emptyMessage.classList.remove('hidden');
                } else {
                    emptyMessage.classList.add('hidden');
                    products.forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col hover:shadow-2xl transition-shadow duration-300 cursor-pointer';

                        const isDiscounted = isCurrentlyDiscounted(product);
                        const displayedPrice = isDiscounted ? product.price : (product.originalPrice || product.price);

                        let discountBadge = '';
                        if (isDiscounted) {
                            const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                            discountBadge = `<span class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">${discountPercent}% OFF</span>`;
                        }

                        let endDateBadge = '';
                        if (isDiscounted && product.period) {
                            const endDateStr = product.period.split('-')[1];
                            endDateBadge = `<span class="absolute bottom-2 right-2 sm:top-2 sm:bottom-auto bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">s/d. ${endDateStr}</span>`;
                        }

                        // Details toggles
                        let detailsHtml = '';
                        if (settings.showSize && product.size) {
                            detailsHtml += `<div class="text-xs text-gray-500 mt-1"><strong>Ukuran:</strong> ${product.size}</div>`;
                        }
                        if (settings.showDesc && product.desc) {
                            detailsHtml += `<div class="text-xs text-gray-500 mt-1"><strong>Deskripsi:</strong> ${product.desc}</div>`;
                        }
                        if (settings.showColor && product.colors && product.colors.length > 0) {
                            detailsHtml += `<div class="flex gap-1 mt-1">` +
                                product.colors.map(color =>
                                    `<span class="color-swatch" style="background-color:${color.hex};" title="${color.name}"></span>`
                                ).join('') +
                                `</div>`;
                        }

                        // Only show add to cart button when checkout mode is enabled
                        const addToCartButton = isCheckoutMode ? 
                            `<button class="add-to-cart-btn mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-2 rounded text-sm" data-product-id="${product.id}">
                                Tambah ke Keranjang
                            </button>` : '';

                        card.innerHTML = `
                            <div class="relative w-full h-48 sm:h-64">
                                <img src="${product.image}" alt="${product.name}"
                                    class="w-full h-full object-cover">
                                    ${discountBadge}
                                    ${endDateBadge}
                            </div>
                            <div class="p-4 flex-grow flex flex-col justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">${product.name}</h3>
                                    <p class="text-sm text-gray-500 capitalize">${product.category}</p>
                                    ${detailsHtml}
                                </div>
                                <div class="mt-auto">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <p class="text-xl font-bold text-indigo-600">${formatRupiah(displayedPrice)}</p>
                                        ${isDiscounted ? `<p class="text-gray-400 line-through text-md">${formatRupiah(product.originalPrice)}</p>` : ''}
                                    </div>
                                    ${addToCartButton}
                                </div>
                            </div>
                        `;

                        card.addEventListener('click', (e) => {
                            // Only open modal if not clicking the add to cart button
                            if (!e.target.classList.contains('add-to-cart-btn')) {
                                showModal(product);
                            }
                        });
                        
                        // Add to cart button event listener (only if button exists)
                        const addToCartBtn = card.querySelector('.add-to-cart-btn');
                        if (addToCartBtn) {
                            addToCartBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const productId = e.target.dataset.productId;
                                addToCart(productId);
                            });
                        }
                        
                        productGrid.appendChild(card);
                    });
                }
            }

            function formatRupiah(number) {
                if (number === null || number === undefined || isNaN(number)) {
                    return '';
                }
                const formatter = new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                });
                return formatter.format(number).replace(/\s/, ' ');
            }
            
            function isDiscountActive(period) {
                if (!period) return false;
                const [start, end] = period.split('-');
                const [sd, sm, sy] = start.split('/').map(Number);
                const [ed, em, ey] = end.split('/').map(Number);
                const startDate = new Date(sy, sm - 1, sd);
                const endDate = new Date(ey, em - 1, ed);
                endDate.setHours(23, 59, 59, 999);
                const now = new Date();
                return now >= startDate && now <= endDate;
            }

            function isCurrentlyDiscounted(item) {
                const hasValidPrices = item.originalPrice && item.originalPrice > item.price;
                if (!hasValidPrices) {
                    return false;
                }
                if (item.period) {
                    return isDiscountActive(item.period);
                }
                return true;
            }
            
            function showModal(item) {
                const modalImage = document.getElementById('modal-image');
                const modalName = document.getElementById('modal-name');
                const modalPrice = document.getElementById('modal-price');
                const modalOriginalPrice = document.getElementById('modal-original-price');
                const modalCategory = document.getElementById('modal-category');
                const modalSize = document.getElementById('modal-size');
                const modalDesc = document.getElementById('modal-desc');
                const modalStock = document.getElementById('modal-stock');
                const modalColors = document.getElementById('modal-colors');

                modalImage.src = item.image;
                const isDiscounted = isCurrentlyDiscounted(item);
                const displayedPrice = isDiscounted ? item.price : (item.originalPrice || item.price);
                
                modalName.textContent = item.name;
                modalCategory.textContent = item.category;
                modalDesc.textContent = item.desc || '-';
                modalSize.textContent = item.size || '-';
                modalStock.textContent = item.stock || 'Ada';
                modalPrice.textContent = formatRupiah(displayedPrice);
                if (isDiscounted) {
                    modalOriginalPrice.textContent = formatRupiah(item.originalPrice);
                    modalOriginalPrice.classList.remove('hidden');
                } else {
                    modalOriginalPrice.textContent = '';
                    modalOriginalPrice.classList.add('hidden');
                }
                
                modalColors.innerHTML = '';
                if (item.colors && item.colors.length > 0) {
                    item.colors.forEach(color => {
                        const colorDiv = document.createElement('div');
                        colorDiv.className = 'flex items-center gap-2';
                        colorDiv.innerHTML = `<span class="color-swatch" style="background-color: ${color.hex};"></span><span>${color.name}</span>`;
                        modalColors.appendChild(colorDiv);
                    });
                } else {
                    modalColors.innerHTML = '<p class="text-sm text-gray-600">Tidak ada pilihan warna.</p>';
                }

                productModal.classList.remove('hidden');
            }

            searchInput.addEventListener('input', filterAndDisplayProducts);

            closeModalButton.addEventListener('click', () => {
                productModal.classList.add('hidden');
            });

            window.addEventListener('click', (event) => {
                if (event.target === productModal) {
                    productModal.classList.add('hidden');
                }
            });

            sortButton.addEventListener('click', () => {
                sortMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!sortButton.contains(e.target) && !sortMenu.contains(e.target)) {
                    sortMenu.classList.add('hidden');
                }
            });

            sortMenu.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentSort = btn.dataset.sort;
                    filterAndDisplayProducts();
                    sortMenu.classList.add('hidden');
                });
            });

            settingsButton.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeSettingsButton.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            window.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            toggleSize.addEventListener('change', () => {
                settings.showSize = toggleSize.checked;
                filterAndDisplayProducts();
            });
            toggleColor.addEventListener('change', () => {
                settings.showColor = toggleColor.checked;
                filterAndDisplayProducts();
            });
            toggleDesc.addEventListener('change', () => {
                settings.showDesc = toggleDesc.checked;
                filterAndDisplayProducts();
            });

            fetchProducts();
        });
    </script>

    <!-- Floating Calculator Button -->
    <div id="floating-calculator" class="fixed bottom-6 right-6 bg-indigo-600 text-white rounded-full shadow-lg p-4 cursor-pointer hover:bg-indigo-700 transition-all duration-300 hidden">
        <div class="flex items-center relative">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <span class="ml-2 font-bold" id="cart-total">Rp 0</span>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </div>
    </div>
</body>
</html>