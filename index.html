<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar styling for a nicer look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Modal overlay styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Color swatch styling */
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 9999px; /* This makes it a perfect circle/rounded square */
            border: 2px solid #e5e7eb; /* Light gray border */
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-7xl mx-auto py-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Katalog Bago Home Decor</h1>
            <p class="text-lg text-gray-500 mt-2">wkwkwkwk</p>
        </header>
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <div id="category-cards" class="flex flex-wrap gap-2 justify-center sm:justify-start w-full sm:w-auto">
                </div>
            
            <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                <div class="relative inline-block text-left">
                <button id="sort-button" type="button"
                    class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
                    aria-expanded="true" aria-haspopup="true">
                    Sort By
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <div id="sort-menu"
                    class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="sort-button">
                    <button data-sort="name-asc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Nama â†‘</button>
                    <button data-sort="name-desc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Nama â†“</button>
                    <button data-sort="price-asc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Harga â†‘</button>
                    <button data-sort="price-desc" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Harga â†“</button>
                    </div>
                </div>
                </div>

                <label for="search-input" class="sr-only">Search products</label>
                <input type="text" id="search-input" placeholder="Search products..."
                    class="block w-full sm:w-64 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                
                <a href="admin.html"
                    class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-200 text-center">
                    ðŸ–‰ Edit Products
                </a>
            </div>
        </div>

        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            </div>

        <div id="empty-message" class="hidden text-center text-gray-500 mt-16">
            <p class="text-xl">No products found for this category. Please add some items from the admin page.</p>
        </div>

    </div>

    <div id="product-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-2xl relative max-h-full overflow-y-auto">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <div id="modal-content" class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0 w-full md:w-1/2">
                    <img id="modal-image" src="" alt="" class="w-full rounded-xl object-cover">
                </div>
                <div class="flex-grow md:w-1/2 space-y-4">
                    <h2 id="modal-name" class="text-3xl font-bold text-gray-800"></h2>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                        <p id="modal-price" class="text-2xl font-bold text-indigo-600"></p>
                        <p id="modal-original-price" class="text-gray-400 line-through text-lg"></p>
                    </div>
                    <p class="text-sm text-gray-500 capitalize">Category: <span id="modal-category" class="font-medium"></span></p>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <p class="text-gray-700 font-semibold">Details:</p>
                        <ul class="text-sm text-gray-600 mt-2 space-y-1">
                            <li><strong class="text-gray-800">Description:</strong> <span id="modal-desc"></span></li>
                            <li><strong class="text-gray-800">Size:</strong> <span id="modal-size"></span></li>
                            <li><strong class="text-gray-800">Stock:</strong> <span id="modal-stock"></span></li>
                        </ul>
                    </div>

                    <div>
                        <p class="text-gray-700 font-semibold">Available Colors:</p>
                        <div id="modal-colors" class="mt-2 space-y-2">
                        </div>
                </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Variable Declarations ---
        const productGrid = document.getElementById('product-grid');
        const emptyMessage = document.getElementById('empty-message');
        const categoryCardsContainer = document.getElementById('category-cards');
        const searchInput = document.getElementById('search-input');
        
        // Modal elements
        const productModal = document.getElementById('product-modal');
        const closeModalButton = document.getElementById('close-modal');
        const modalImage = document.getElementById('modal-image');
        const modalName = document.getElementById('modal-name');
        const modalPrice = document.getElementById('modal-price');
        const modalOriginalPrice = document.getElementById('modal-original-price');
        const modalCategory = document.getElementById('modal-category');
        const modalSize = document.getElementById('modal-size');
        const modalDesc = document.getElementById('modal-desc');
        const modalStock = document.getElementById('modal-stock');
        const modalColors = document.getElementById('modal-colors');

        let allItems = [];
        let currentFilter = 'all';

        // --- 2. Function Definitions ---
        /**
         * Helper function to format numbers as Indonesian Rupiah (Rp) with dot separators.
         * @param {number} number - The number to format.
         * @returns {string} The formatted currency string.
         */
        function formatRupiah(number) {
            if (number === null || number === undefined || isNaN(number)) {
                return '';
            }
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            // The formatter adds "Rp" and a non-breaking space, which is the standard format.
            return formatter.format(number).replace(/\s/, ' ');
        }
        
        /**
         * Check if current date is within the discount period.
         * @param {string} period - Format "dd/mm/yyyy-dd/mm/yyyy"
         * @returns {boolean}
         */
        function isDiscountActive(period) {
            if (!period) return false;
            const [start, end] = period.split('-');
            const [sd, sm, sy] = start.split('/').map(Number);
            const [ed, em, ey] = end.split('/').map(Number);
            const startDate = new Date(sy, sm - 1, sd);
            const endDate = new Date(ey, em - 1, ed);
            // Set time to end of day for endDate
            endDate.setHours(23, 59, 59, 999);
            const now = new Date();
            return now >= startDate && now <= endDate;
        }

        /**
         * Determines if an item is currently on discount.
         * @param {object} item - The product item.
         * @returns {boolean}
         */
        function isCurrentlyDiscounted(item) {
            // Rule 2 & 3: Must have originalPrice > price to be considered for any discount.
            const hasValidPrices = item.originalPrice && item.originalPrice > item.price;
            if (!hasValidPrices) {
                return false;
            }
            // Rule 3: If a period exists, the discount is only active if the current date is within that period.
            if (item.period) {
                return isDiscountActive(item.period);
            }
            // Rule 2: If no period, it's a permanent discount.
            return true;
        }
        
        // Function to create a single product card element
        function renderProductCard(item) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col hover:shadow-2xl transition-shadow duration-300 cursor-pointer';

            const isDiscounted = isCurrentlyDiscounted(item);
            
            // Rule 1, 2, 3: Determine the correct price to display.
            // If discounted, show 'price'. If not (e.g., expired sale), show 'originalPrice'. Otherwise, show 'price'.
            const displayedPrice = isDiscounted ? item.price : (item.originalPrice || item.price);
            
            let discountBadge = '';
            if (isDiscounted) {
                const discountPercent = Math.round(((item.originalPrice - item.price) / item.originalPrice) * 100);
                discountBadge = `<span class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">${discountPercent}% OFF</span>`;
            }

            card.innerHTML = `
                <div class="relative w-full h-48 sm:h-64">
                    <img src="${item.image}" alt="${item.name}"
                        class="w-full h-full object-cover">
                        ${discountBadge}
                </div>
                <div class="p-4 flex-grow flex flex-col justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                        <p class="text-sm text-gray-500 capitalize">${item.category}</p>
                    </div>
                    <div class="mt-auto">
                        <div class="flex items-center gap-2">
                            <p class="text-xl font-bold text-indigo-600">${formatRupiah(displayedPrice)}</p>
                            ${isDiscounted ? `<p class="text-gray-400 line-through text-md">${formatRupiah(item.originalPrice)}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;

            card.addEventListener('click', () => showModal(item));
            return card;
        }

        // Function to filter and render products based on the current filter and search input
        function filterAndRenderProducts() {
            productGrid.innerHTML = '';
            const searchText = searchInput.value.toLowerCase();

            let filteredItems = allItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchText) || (item.category && item.category.toLowerCase().includes(searchText));

                // Rule 2 & 3: Special filtering for the 'discount' category.
                if (currentFilter === 'discount') {
                    return isCurrentlyDiscounted(item) && matchesSearch;
                }
                
                // Rule 1 & 5: Filter by category or show all.
                // This ensures discounted items also appear in their respective category filters.
                const matchesCategory = currentFilter === 'all' || (item.category && item.category.toLowerCase() === currentFilter.toLowerCase());
                
                return matchesCategory && matchesSearch;
            });
            
            if (currentSort) {
                filteredItems = sortItems(filteredItems, currentSort);
            }
            
            if (filteredItems.length > 0) {
                filteredItems.forEach(item => {
                    productGrid.appendChild(renderProductCard(item));
                });
                emptyMessage.classList.add('hidden');
            } else {
                emptyMessage.classList.remove('hidden');
            }
        }

        // Function to handle the display of the modal
        function showModal(item) {
            modalImage.src = item.image;
            const isDiscounted = isCurrentlyDiscounted(item);
            // Rule 1, 2, 3: Determine the correct price to display in the modal.
            const displayedPrice = isDiscounted ? item.price : (item.originalPrice || item.price);
            
            modalName.textContent = item.name;
            modalCategory.textContent = item.category;
            modalDesc.textContent = item.desc || 'No description available.';
            modalSize.textContent = item.size || 'N/A';
            modalStock.textContent = item.stock || 'In Stock';
            modalPrice.textContent = formatRupiah(displayedPrice);
            if (isDiscounted) {
                modalOriginalPrice.textContent = formatRupiah(item.originalPrice);
                modalOriginalPrice.classList.remove('hidden');
            } else {
                modalOriginalPrice.textContent = '';
                modalOriginalPrice.classList.add('hidden');
            }
            
            // Handle colors
            modalColors.innerHTML = '';
            if (item.colors && item.colors.length > 0) {
                item.colors.forEach(color => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'flex items-center gap-2';
                    colorDiv.innerHTML = `<span class="color-swatch" style="background-color: ${color.hex};"></span><span>${color.name}</span>`;
                    modalColors.appendChild(colorDiv);
                });
            } else {
                modalColors.innerHTML = '<p class="text-sm text-gray-600">No color options available.</p>';
            }

            productModal.classList.remove('hidden');
        }

        // --- 3. Event Listeners and Initial Load ---
        searchInput.addEventListener('input', filterAndRenderProducts);

        closeModalButton.addEventListener('click', () => {
            productModal.classList.add('hidden');
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === productModal) {
                productModal.classList.add('hidden');
            }
        });

        async function fetchProducts() {
            try {
                const response = await fetch('db.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allItems = await response.json();
                
                // Extract unique categories
                const categories = ['all', 'discount', ...new Set(allItems.map(item => item.category))].filter(Boolean);
                renderCategories(categories);
                
                filterAndRenderProducts();
            } catch (error) {
                console.error('Could not fetch products:', error);
                emptyMessage.classList.remove('hidden');
                emptyMessage.textContent = 'Failed to load products. Please ensure db.json is available.';
            }
        }

        // Function to render category cards
        function renderCategories(categories) {
            categoryCardsContainer.innerHTML = '';
            categories.forEach(category => {
                const card = document.createElement('button');
                card.dataset.category = category;
                card.className = 'py-2 px-4 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer';

                // Set the text for the card
                if (category === 'all') {
                    card.textContent = 'All Categories';
                } else if (category === 'discount') {
                    card.textContent = 'Discount';
                } else {
                    card.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                }

                // Add a class for the active card
                if (category === currentFilter) {
                    card.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                } else {
                    card.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                }

                card.addEventListener('click', () => {
                    currentFilter = category;
                    renderCategories(categories); // Re-render to update active state
                    filterAndRenderProducts();
                });
                categoryCardsContainer.appendChild(card);
            });
        }
        
        const sortButton = document.getElementById('sort-button');
        const sortMenu = document.getElementById('sort-menu');

        sortButton.addEventListener('click', () => {
            sortMenu.classList.toggle('hidden');
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', (e) => {
            if (!sortButton.contains(e.target) && !sortMenu.contains(e.target)) {
                sortMenu.classList.add('hidden');
            }
        });

        // Handle sort option click
        sortMenu.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                currentSort = btn.dataset.sort;
                filterAndRenderProducts();
                sortMenu.classList.add('hidden');
            });
        });


        // Call the function to load products when the page loads
        document.addEventListener('DOMContentLoaded', fetchProducts);

        let currentSort = null;

        function sortItems(items, sortType) {
            switch (sortType) {
                case 'name-asc':
                    return items.sort((a, b) => a.name.localeCompare(b.name));
                case 'name-desc':
                    return items.sort((a, b) => b.name.localeCompare(a.name));
                case 'price-asc':
                    return items.sort((a, b) => a.price - b.price);
                case 'price-desc':
                    return items.sort((a, b) => b.price - a.price);
                default:
                    return items;
            }
        }

    </script>
</body>
</html>